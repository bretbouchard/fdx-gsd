---
phase: 04-validation
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - core/validation/timeline_validator.py
  - core/validation/__init__.py
autonomous: true

must_haves:
  truths:
    - "TIME-01 detects impossible travel between distant locations"
    - "TIME-02 flags unresolved relative time phrases"
    - "TIME-04 catches characters in two places at once"
    - "Issues link to scene entities and location evidence"
  artifacts:
    - path: "core/validation/timeline_validator.py"
      provides: "TimelineValidator implementing TIME-01/02/04"
      min_lines: 150
  key_links:
    - from: "TimelineValidator.validate()"
      to: "StoryGraph.scenes"
      via: "scene timeline analysis"
      pattern: "scenes.*time_of_day"
    - from: "TimelineValidator.validate()"
      to: "StoryGraph.entities (locations)"
      via: "location distance lookup"
      pattern: "location.*distance"
---

<objective>
Implement TimelineValidator with TIME-01/02/04 continuity rules.

Purpose: Detect timeline inconsistencies - impossible travel, ambiguous time references, character location conflicts.
Output: TimelineValidator class extending BaseValidator
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-validation/04-01-SUMMARY.md

# Reference the base validator pattern
@core/validation/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TimelineValidator</name>
  <files>core/validation/timeline_validator.py, core/validation/__init__.py</files>
  <action>
Create TimelineValidator class extending BaseValidator:

1. **TIME_MARKERS** class attribute - patterns for time references:
   - TIME_SKIPS = ["LATER", "MOMENTS LATER", "THE NEXT DAY", "THREE DAYS LATER", "HOURS LATER"]
   - CONTINUOUS_MARKERS = ["CONTINUOUS", "SAME TIME", "MOMENTS LATER"]
   - RELATIVE_PHRASES = [r"later that", r"earlier that", r"the following", r"the previous", r"before", r"after"]

2. **LOCATION_DISTANCES** class attribute - optional distance matrix:
   - Dict mapping (location_a, location_b) -> travel_time_minutes
   - Can be empty if not configured; validator works without it (less strict)

3. **validate() -> List[Issue]** implementation:
   - Call _load_graphs()
   - Build scene timeline: ordered list of scenes with time/location metadata
   - Build character timeline: character_id -> [{scene_id, scene_num, location_id, time_marker, evidence_ids}]
   - Run _check_impossible_travel() -> TIME-01 issues
   - Run _check_unresolved_time_phrases() -> TIME-02 issues
   - Run _check_character_location_conflicts() -> TIME-04 issues
   - Return sorted issues

4. **_build_scene_timeline() -> List[Dict]**:
   - Extract scenes from StoryGraph sorted by scene_number
   - For each scene, extract: scene_id, scene_number, location, time_of_day, int_ext, time_marker, evidence_ids
   - Return ordered timeline

5. **_build_character_timeline() -> Dict[str, List[Dict]]**:
   - For each character entity, find all scenes they appear in
   - Track location and time for each appearance
   - Return character timeline dict

6. **_check_impossible_travel(timeline: Dict)** - TIME-01:
   - For each character, check consecutive scene appearances
   - If character moves between locations:
     - Calculate or lookup travel time between locations
     - Check if time marker allows sufficient travel time
   - If travel impossible, create ERROR issue
   - Suggested fix: "Add travel time or cut between {location_a} and {location_b}"

7. **_check_unresolved_time_phrases(timeline: List[Dict])** - TIME-02:
   - Scan scene content for RELATIVE_PHRASES
   - Check if relative phrase references a specific time anchor
   - If anchor unclear or missing, create WARNING issue
   - Suggested fix: "Clarify '{phrase}' - add explicit time reference"

8. **_check_character_location_conflicts(char_timeline: Dict)** - TIME-04:
   - For each pair of scenes with CONTINUOUS/SAME_TIME markers
   - Check if any character appears in both scenes at different locations
   - If conflict found, create ERROR issue
   - Suggested fix: "Character {name} cannot be in both {loc_a} and {loc_b} at same time"

9. **_get_travel_time(location_a: str, location_b: str) -> Optional[int]**:
   - Lookup in LOCATION_DISTANCES if available
   - Return estimated travel time in minutes, or None if unknown

10. **_scenes_are_simultaneous(scene_a: Dict, scene_b: Dict) -> bool**:
    - Check if both have CONTINUOUS or SAME_TIME markers
    - Return True if scenes occur at same story time

11. **_extract_time_marker(scene: Dict) -> Optional[str]**:
    - Check scene attributes for time markers
    - Check scene content for TIME_SKIPS and CONTINUOUS_MARKERS
    - Return detected marker or None

12. **Update __init__.py** to export TimelineValidator

Note: Be careful with non-linear storytelling (flashbacks, parallel action). Only flag issues when scene metadata indicates continuous time. Flashbacks should have explicit markers.
  </action>
  <verify>python -c "from core.validation import TimelineValidator, IssueCategory; from pathlib import Path; tv = TimelineValidator(Path('.')); print(f'Category: {IssueCategory.TIMELINE}')" </verify>
  <done>TimelineValidator implements validate() returning List[Issue], covers TIME-01/02/04 rules, extends BaseValidator</done>
</task>

</tasks>

<verification>
- Run: python -c "from core.validation import TimelineValidator; from pathlib import Path; tv = TimelineValidator(Path('.')); issues = tv.validate(); print(f'Found {len(issues)} issues')"
- Verify TIME-01 issues have severity=ERROR
- Verify TIME-02 issues have severity=WARNING
- Verify TIME-04 issues have severity=ERROR
- Verify all issues have rule_code starting with "TIME-"
</verification>

<success_criteria>
- TIME-01 detects impossible travel (ERROR)
- TIME-02 flags unresolved relative phrases (WARNING)
- TIME-04 catches character location conflicts (ERROR)
- Handles non-linear storytelling gracefully (only flags continuous time)
- All issues link to scene and location evidence
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation/04-04-SUMMARY.md`
</output>
