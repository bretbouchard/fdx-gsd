---
phase: 04-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - core/validation/__init__.py
  - core/validation/base.py
  - core/validation/report_generator.py
autonomous: true

must_haves:
  truths:
    - "Issue data model exists with severity (error/warning/info) and category"
    - "BaseValidator provides common interface for all validators"
    - "ReportGenerator creates Obsidian-compatible markdown in vault/80_Reports/"
    - "Issues persist to build/issues.json with deterministic sorting"
  artifacts:
    - path: "core/validation/base.py"
      provides: "Issue, IssueSeverity, IssueCategory, BaseValidator"
      min_lines: 100
    - path: "core/validation/report_generator.py"
      provides: "ReportGenerator for markdown reports"
      min_lines: 80
  key_links:
    - from: "BaseValidator"
      to: "StoryGraph"
      via: "_load_graphs()"
      pattern: "json.loads.*storygraph"
    - from: "ReportGenerator"
      to: "vault/80_Reports/"
      via: "generate_reports()"
      pattern: "reports_path.*mkdir"
---

<objective>
Create the validation foundation module with Issue data model, BaseValidator abstract class, and ReportGenerator.

Purpose: Establish the common infrastructure that all validators (Wardrobe, Props, Timeline, Knowledge) will extend, following the ConflictResolver pattern from Phase 3.
Output: core/validation/ module with base classes and report generation
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation/04-RESEARCH.md

# Reference the ConflictResolver pattern for Issue/Severity design
@core/sync/conflict_resolver.py

# Reference the CanonBuilder pattern for BaseValidator structure
@core/canon/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Issue data model and BaseValidator</name>
  <files>core/validation/base.py, core/validation/__init__.py</files>
  <action>
Create core/validation/ directory and implement:

1. **IssueSeverity enum** - mirrors ConflictTier pattern:
   - ERROR = "error" (maps to CRITICAL - must fix)
   - WARNING = "warning" (maps to AMBIGUOUS - should review)
   - INFO = "info" (maps to SAFE - FYI only)

2. **IssueCategory enum**:
   - WARDROBE = "wardrobe"
   - PROPS = "props"
   - TIMELINE = "timeline"
   - KNOWLEDGE = "knowledge"

3. **Issue dataclass** - mirrors Conflict dataclass pattern:
   - issue_id: str (format: "issue_{category}_{counter:06d}")
   - category: IssueCategory
   - severity: IssueSeverity
   - rule_code: str (e.g., "WARD-01", "PROP-02")
   - title: str
   - description: str
   - scene_id: Optional[str]
   - scene_number: Optional[int]
   - entity_ids: List[str]
   - evidence_ids: List[str]
   - source_paragraph: Optional[str]
   - suggested_fix: Optional[str]
   - auto_fixable: bool = False
   - detected_at: datetime
   - resolved: bool = False
   - resolved_at: Optional[datetime]
   - resolution_note: Optional[str]
   - to_dict() and from_dict() methods for JSON serialization

4. **BaseValidator abstract class** - mirrors CanonBuilder pattern:
   - __init__(self, build_path: Path)
   - _load_graphs() - loads storygraph.json and scriptgraph.json
   - _create_issue_id(rule_code: str) - generates unique issue ID
   - validate() -> List[Issue] - abstract method
   - get_issues() -> List[Issue]
   - get_summary() -> Dict[str, Any]
   - Protected attributes: _issues, _storygraph, _scriptgraph, _issue_counter

5. **Update __init__.py** to export:
   - Issue, IssueSeverity, IssueCategory
   - BaseValidator

Do NOT implement specific validator rules yet (WARD-01, PROP-01, etc.) - this is foundation only.
  </action>
  <verify>python -c "from core.validation import Issue, IssueSeverity, IssueCategory, BaseValidator; print('OK')" && python -c "from core.validation.base import Issue; i = Issue(issue_id='test', category=IssueCategory.WARDROBE, severity=IssueSeverity.ERROR, rule_code='WARD-01', title='Test', description='Test'); print(i.to_dict())"</verify>
  <done>Issue dataclass with to_dict/from_dict, IssueSeverity enum, IssueCategory enum, BaseValidator abstract class with _load_graphs method, all exported from __init__.py</done>
</task>

<task type="auto">
  <name>Task 2: Create ReportGenerator</name>
  <files>core/validation/report_generator.py, core/validation/__init__.py</files>
  <action>
Create ReportGenerator class that produces Obsidian-compatible markdown reports:

1. **ReportGenerator class**:
   - __init__(self, vault_path: Path)
   - self.reports_path = vault_path / "80_Reports"
   - self.reports_path.mkdir(parents=True, exist_ok=True)

2. **generate_reports(all_issues: List[Issue]) -> Dict[str, Path]**:
   - Creates validation-summary.md with:
     - Generated timestamp
     - Total issues count
     - Table by severity (error/warning/info with status icons)
     - Table by category (wardrobe/props/timeline/knowledge)
     - List of critical issues (errors) with scene links
     - Links to detailed reports
   - Creates {category}-issues.md for each category with issues:
     - Grouped by scene number
     - Each issue shows: severity icon, rule code, title, description
     - Detailed entries include: scene wikilink, entity wikilinks, evidence wikilinks, suggested fix

3. **_format_issue_entry(issue: Issue, detailed: bool = False) -> str**:
   - Severity emoji: ERROR=❌, WARNING=⚠️, INFO=ℹ️
   - Format with Obsidian wikilinks: [[scene_id]], [[entity_id]], [[evidence#^block]]
   - Include suggested_fix if available

4. **Update __init__.py** to export ReportGenerator

The reports must be readable in Obsidian with working wikilinks to scenes and entities.
  </action>
  <verify>python -c "from core.validation import ReportGenerator, Issue, IssueSeverity, IssueCategory; from pathlib import Path; import tempfile; p = Path(tempfile.mkdtemp()); rg = ReportGenerator(p / 'vault'); i = Issue(issue_id='test', category=IssueCategory.WARDROBE, severity=IssueSeverity.WARNING, rule_code='WARD-01', title='Test issue', description='Test desc', scene_number=1); paths = rg.generate_reports([i]); print(f'Created: {list(paths.keys())}')" </verify>
  <done>ReportGenerator creates vault/80_Reports/ directory, generates validation-summary.md and category-specific markdown files with Obsidian wikilinks</done>
</task>

</tasks>

<verification>
- Run: python -c "from core.validation import Issue, IssueSeverity, IssueCategory, BaseValidator, ReportGenerator"
- Verify Issue has to_dict/from_dict methods
- Verify BaseValidator has abstract validate() method
- Verify ReportGenerator creates reports directory
</verification>

<success_criteria>
- Issue data model matches Conflict pattern from Phase 3
- BaseValidator follows CanonBuilder pattern
- ReportGenerator produces Obsidian-compatible markdown
- All classes properly exported from core.validation
- No external dependencies added (stdlib only)
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation/04-01-SUMMARY.md`
</output>
