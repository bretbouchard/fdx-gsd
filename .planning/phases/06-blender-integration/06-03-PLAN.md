---
phase: 06-blender-integration
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - core/layout/exporter.py
  - core/layout/__init__.py
  - apps/cli/cli.py
autonomous: true

must_haves:
  truths:
    - "CLI command 'gsd generate-layout' produces layout brief JSON files"
    - "Layout briefs saved to blender/<scene_id>/layout_brief.json"
    - "Command requires scriptgraph.json and shotgraph.json to exist"
    - "JSON output is deterministic (sorted, indented)"
  artifacts:
    - path: "core/layout/exporter.py"
      provides: "LayoutBriefExporter for file output"
      exports: ["LayoutBriefExporter", "export_layout_brief"]
    - path: "apps/cli/cli.py"
      provides: "CLI command generate-layout"
      contains: "cmd_generate_layout"
  key_links:
    - from: "core/layout/exporter.py"
      to: "core/layout/models.py"
      via: "imports LayoutBrief for export"
      pattern: "from .models import LayoutBrief"
    - from: "apps/cli/cli.py"
      to: "core/layout/generator.py"
      via: "imports LayoutBriefGenerator for CLI command"
      pattern: "from core.layout import"
---

<objective>
Create CLI command and exporter for layout brief generation.

Purpose: Expose layout generation via CLI and create Blender-compatible JSON output files.
Output: `gsd generate-layout` command that creates blender/<scene_id>/layout_brief.json files.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-blender-integration/06-RESEARCH.md

# Reference existing patterns
@core/shots/exporter.py
@core/shots/suggester.py
@apps/cli/cli.py

# Prior plan outputs (will exist)
@core/layout/models.py
@core/layout/generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LayoutBriefExporter</name>
  <files>
    core/layout/exporter.py
    core/layout/__init__.py
  </files>
  <action>
    Create LayoutBriefExporter following the ShotListExporter pattern from core/shots/exporter.py.

    The exporter should:
    1. Export LayoutBrief to individual scene JSON files
    2. Output to blender/<scene_id>/layout_brief.json structure
    3. Also export combined layout_brief.json to build/

    Class structure:
    ```python
    class LayoutBriefExporter:
        def __init__(self, output_path: Path):
            self.output_path = Path(output_path)

        def export(self, brief: LayoutBrief) -> Dict[str, Path]:
            \"\"\"
            Export layout brief to files.

            Returns:
                Dict mapping scene_id to output file path
            \"\"\"
            paths = {}

            # Create blender/ directory
            blender_path = self.output_path / "blender"
            blender_path.mkdir(parents=True, exist_ok=True)

            # Export per-scene files
            for scene_layout in brief.scene_layouts:
                scene_dir = blender_path / scene_layout.scene_id
                scene_dir.mkdir(parents=True, exist_ok=True)

                scene_file = scene_dir / "layout_brief.json"
                self._export_scene(scene_layout, scene_file)
                paths[scene_layout.scene_id] = scene_file

            return paths

        def _export_scene(self, scene: SceneLayout, path: Path) -> None:
            \"\"\"Export single scene to JSON.\"\"\"
            data = scene.to_dict()
            path.write_text(json.dumps(data, indent=2, sort_keys=True))

        def export_combined(self, brief: LayoutBrief, path: Path) -> None:
            \"\"\"Export combined brief to single file.\"\"\"
            brief.save(path)  # Uses LayoutBrief.save() from models.py
    ```

    Also add convenience function:
    ```python
    def export_layout_brief(brief: LayoutBrief, output_path: Path) -> Dict[str, Path]:
        \"\"\"Convenience function to export layout brief.\"\"\"
        exporter = LayoutBriefExporter(output_path)
        return exporter.export(brief)
    ```

    Update __init__.py to export:
    ```python
    from .exporter import LayoutBriefExporter, export_layout_brief
    ```

    IMPORTANT:
    - Output must be deterministic (sorted keys, consistent indentation)
    - Create directory structure: blender/<scene_id>/layout_brief.json
    - Handle empty scene_layouts gracefully
  </action>
  <verify>
    python -c "
from core.layout import LayoutBriefExporter, export_layout_brief
print('LayoutBriefExporter import OK')
"
  </verify>
  <done>
    - core/layout/exporter.py exists with LayoutBriefExporter class
    - export() creates blender/<scene_id>/layout_brief.json files
    - JSON output is deterministic (sorted keys, indent=2)
    - __init__.py updated with exporter exports
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI command 'gsd generate-layout'</name>
  <files>apps/cli/cli.py</files>
  <action>
    Add generate-layout command to the CLI following the cmd_suggest_shots pattern.

    1. Create cmd_generate_layout function:
    ```python
    def cmd_generate_layout(args: argparse.Namespace) -> int:
        \"\"\"
        Generate layout briefs from ScriptGraph + ShotGraph.

        Creates Blender-compatible JSON files for scene previz.

        Usage: gsd generate-layout
        \"\"\"
        project_path, exit_code = find_project_root()
        if exit_code != 0:
            print("Error: Not in a GSD project.", file=sys.stderr)
            return exit_code

        build_path = project_path / "build"

        # Check prerequisites
        scriptgraph_path = build_path / "scriptgraph.json"
        if not scriptgraph_path.exists():
            print("Error: No scriptgraph.json found. Run 'gsd build script' first.")
            return 1

        shotgraph_path = build_path / "shotgraph.json"
        if not shotgraph_path.exists():
            print("Error: No shotgraph.json found. Run 'gsd suggest-shots' first.")
            return 1

        print("Generating layout briefs...")
        print()

        from core.layout import LayoutBriefGenerator, LayoutBriefExporter

        # Run generator
        generator = LayoutBriefGenerator(build_path)
        brief = generator.generate()

        # Export
        exporter = LayoutBriefExporter(project_path)
        paths = exporter.export(brief)

        # Print results
        print("=== Layout Generation Results ===")
        print(f"Scenes processed: {len(brief.scene_layouts)}")
        print()

        for scene_layout in brief.scene_layouts:
            print(f"  {scene_layout.scene_id}:")
            print(f"    Cameras: {len(scene_layout.camera_setups)}")
            print(f"    Characters: {len(scene_layout.characters)}")
            print(f"    Output: blender/{scene_layout.scene_id}/layout_brief.json")

        print()
        print(f"Combined brief: build/layout_brief.json")
        print()
        print("\033[92mLayout briefs generated\033[0m")

        return 0
    ```

    2. Add subparser in main():
    ```python
    # generate-layout
    p_layout = subparsers.add_parser("generate-layout", help="Generate Blender layout briefs")
    p_layout.set_defaults(func=cmd_generate_layout)
    ```

    Place the command after suggest-shots in the argument parser setup (around line 1400).
  </action>
  <verify>
    python -c "
import sys
sys.path.insert(0, '/Users/bretbouchard/apps/fdx_gsd')
from apps.cli.cli import main
print('CLI import OK')
"
    # Also verify command appears in help
    python -m apps.cli.cli --help | grep -q "generate-layout" && echo "command registered"
  </verify>
  <done>
    - cmd_generate_layout function added to cli.py
    - generate-layout subparser added in main()
    - Command appears in 'gsd --help' output
    - Command checks for scriptgraph.json and shotgraph.json
    - Command generates layout briefs to blender/ directory
  </done>
</task>

</tasks>

<verification>
1. LayoutBriefExporter can export LayoutBrief to files
2. Output creates blender/<scene_id>/layout_brief.json structure
3. 'gsd generate-layout' command is available
4. Command validates prerequisites (scriptgraph, shotgraph)
5. JSON output is deterministic
</verification>

<success_criteria>
- LayoutBriefExporter in core/layout/exporter.py
- CLI command 'gsd generate-layout' works
- Output creates blender/<scene_id>/layout_brief.json files
- Combined brief exported to build/layout_brief.json
- Command reports results with scene counts
</success_criteria>

<output>
After completion, create `.planning/phases/06-blender-integration/06-03-SUMMARY.md`
</output>
