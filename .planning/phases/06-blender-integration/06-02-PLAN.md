---
phase: 06-blender-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - core/layout/generator.py
  - core/layout/__init__.py
autonomous: true

must_haves:
  truths:
    - "LayoutBriefGenerator reads ScriptGraph and ShotGraph and produces LayoutBrief"
    - "Each scene gets a SceneLayout with camera setups from shots"
    - "Character positions are calculated from scene character links"
    - "Evidence IDs are propagated from source data"
  artifacts:
    - path: "core/layout/generator.py"
      provides: "LayoutBriefGenerator orchestrator following ShotSuggester pattern"
      exports: ["LayoutBriefGenerator", "generate_layout_brief"]
  key_links:
    - from: "core/layout/generator.py"
      to: "core/layout/models.py"
      via: "imports SceneLayout, CameraSetup, CharacterPosition"
      pattern: "from .models import"
    - from: "core/layout/generator.py"
      to: "core/layout/camera_math.py"
      via: "imports calculate_camera_position for camera setup"
      pattern: "from .camera_math import"
    - from: "core/layout/generator.py"
      to: "core/shots/models.py"
      via: "imports Shot, ShotList for shot data"
      pattern: "from core.shots.models import"
---

<objective>
Create LayoutBriefGenerator to transform ScriptGraph + ShotGraph into LayoutBrief.

Purpose: Generate spatial layout data from screenplay content for Blender consumption.
Output: LayoutBriefGenerator class that produces LayoutBrief with scene layouts, camera setups, and character positions.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-blender-integration/06-RESEARCH.md

# Reference existing patterns
@core/shots/suggester.py
@core/shots/models.py

# Prior plan output (will exist)
@core/layout/models.py
@core/layout/camera_math.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LayoutBriefGenerator class</name>
  <files>core/layout/generator.py</files>
  <action>
    Create LayoutBriefGenerator following the ShotSuggester pattern from core/shots/suggester.py.

    The generator should:
    1. Load ScriptGraph from build/scriptgraph.json
    2. Load ShotGraph from build/shotgraph.json
    3. For each scene in ScriptGraph:
       - Create SceneLayout with scene metadata
       - Map scene characters to CharacterPosition objects (simple grid positioning)
       - Map scene shots to CameraSetup objects using camera_math
       - Propagate evidence_ids from source data

    Key class structure:
    ```python
    @dataclass
    class LayoutGenerationResult:
        success: bool
        scenes_processed: int = 0
        layouts_generated: int = 0
        errors: List[str] = field(default_factory=list)

    class LayoutBriefGenerator:
        def __init__(self, build_path: Path):
            self.build_path = Path(build_path)
            self._scriptgraph: Optional[Dict] = None
            self._shotgraph: Optional[Dict] = None
            self._project_id: str = ""

        def generate(self) -> LayoutBrief:
            """Generate complete layout brief."""
            ...

        def _load_source_data(self) -> None:
            """Load scriptgraph.json and shotgraph.json."""
            ...

        def _get_shots_for_scene(self, scene_id: str) -> List[Shot]:
            """Get all shots for a scene from ShotGraph."""
            ...

        def _build_scene_layout(self, scene_data: Dict, shots: List[Shot]) -> SceneLayout:
            """Build scene layout from scene + shots."""
            ...

        def _build_character_positions(self, scene_data: Dict) -> List[CharacterPosition]:
            """Create character positions (simple grid layout for now)."""
            # Space characters along X axis
            # Position: x = (index - count/2) * 1.5, y = 0, z = 0
            # Facing: x=0, y=1, z=0 (forward)
            ...

        def _build_camera_setup(self, shot: Shot, characters: List[CharacterPosition]) -> CameraSetup:
            """Build camera setup from shot using camera_math."""
            # Get subject position (first character or default)
            # Call calculate_camera_position()
            # Build CameraSetup dict
            ...

        def get_layout_brief(self) -> LayoutBrief:
            """Get the generated LayoutBrief."""
            ...
    ```

    Also create convenience function:
    ```python
    def generate_layout_brief(build_path: Path) -> LayoutGenerationResult:
        """Convenience function to generate layout brief."""
        ...
    ```

    IMPORTANT:
    - All lists in output must be sorted for determinism (by id fields)
    - Evidence IDs must propagate from ScriptGraph scenes and ShotGraph shots
    - Character positions use simple grid layout (blocking analysis deferred)
    - Camera setups use calculate_camera_position() from camera_math
    - Handle missing data gracefully (empty lists, default values)
  </action>
  <verify>
    python -c "
from pathlib import Path
from core.layout.generator import LayoutBriefGenerator
print('LayoutBriefGenerator import OK')
"
  </verify>
  <done>
    - core/layout/generator.py exists with LayoutBriefGenerator class
    - generate() method returns LayoutBrief with all scene layouts
    - Character positions calculated from scene character links
    - Camera setups calculated from shots using camera_math
    - Evidence IDs propagated correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Update core/layout/__init__.py with generator exports</name>
  <files>core/layout/__init__.py</files>
  <action>
    Update __init__.py to export the generator:
    ```python
    from .models import (
        LayoutBrief,
        SceneLayout,
        CameraSetup,
        CharacterPosition,
        PropPosition,
    )
    from .camera_math import (
        calculate_camera_position,
        CameraPosition,
        CameraRotation,
    )
    from .generator import (
        LayoutBriefGenerator,
        generate_layout_brief,
        LayoutGenerationResult,
    )

    __all__ = [
        # Models
        "LayoutBrief",
        "SceneLayout",
        "CameraSetup",
        "CharacterPosition",
        "PropPosition",
        # Camera math
        "calculate_camera_position",
        "CameraPosition",
        "CameraRotation",
        # Generator
        "LayoutBriefGenerator",
        "generate_layout_brief",
        "LayoutGenerationResult",
    ]
    ```
  </action>
  <verify>
    python -c "
from core.layout import LayoutBriefGenerator, generate_layout_brief, LayoutGenerationResult
print('all exports OK')
"
  </verify>
  <done>
    - __init__.py updated with generator exports
    - All imports work correctly
  </done>
</task>

</tasks>

<verification>
1. LayoutBriefGenerator can be instantiated with build_path
2. generate() returns valid LayoutBrief
3. SceneLayouts are created for each scene in ScriptGraph
4. CameraSetups use correct positions from camera_math
5. Evidence IDs are present in output
</verification>

<success_criteria>
- LayoutBriefGenerator class in core/layout/generator.py
- generate() method reads ScriptGraph + ShotGraph and produces LayoutBrief
- SceneLayouts include characters, props (empty for now), and camera_setups
- CameraSetups use calculate_camera_position() for correct distances
- Evidence chain maintained from source to output
</success_criteria>

<output>
After completion, create `.planning/phases/06-blender-integration/06-02-SUMMARY.md`
</output>
