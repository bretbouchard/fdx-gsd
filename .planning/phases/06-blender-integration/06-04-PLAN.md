---
phase: 06-blender-integration
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - tests/unit/test_layout_models.py
  - tests/unit/test_layout_camera_math.py
  - tests/unit/test_layout_generator.py
  - tests/integration/test_layout_workflow.py
autonomous: true

must_haves:
  truths:
    - "All layout models serialize and deserialize correctly"
    - "Camera position calculation produces valid coordinates for all shot types"
    - "LayoutBriefGenerator processes ScriptGraph and ShotGraph correctly"
    - "CLI command works end-to-end"
  artifacts:
    - path: "tests/unit/test_layout_models.py"
      provides: "Unit tests for layout data models"
    - path: "tests/unit/test_layout_camera_math.py"
      provides: "Unit tests for camera position calculation"
    - path: "tests/unit/test_layout_generator.py"
      provides: "Unit tests for LayoutBriefGenerator"
    - path: "tests/integration/test_layout_workflow.py"
      provides: "Integration tests for full layout generation workflow"
  key_links:
    - from: "tests/unit/test_layout_models.py"
      to: "core/layout/models.py"
      via: "tests all dataclasses"
    - from: "tests/unit/test_layout_camera_math.py"
      to: "core/layout/camera_math.py"
      via: "tests camera position calculation"
    - from: "tests/unit/test_layout_generator.py"
      to: "core/layout/generator.py"
      via: "tests LayoutBriefGenerator"
    - from: "tests/integration/test_layout_workflow.py"
      to: "apps/cli/cli.py"
      via: "tests CLI command end-to-end"
---

<objective>
Create comprehensive test suite for layout brief generation.

Purpose: Ensure layout models, camera math, generator, and CLI work correctly.
Output: Unit and integration tests covering all layout functionality.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-blender-integration/06-RESEARCH.md

# Reference existing test patterns
@tests/integration/test_shot_workflow.py

# Prior plan outputs (will exist)
@core/layout/models.py
@core/layout/camera_math.py
@core/layout/generator.py
@core/layout/exporter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for layout models</name>
  <files>tests/unit/test_layout_models.py</files>
  <action>
    Create comprehensive unit tests for all layout dataclasses.

    Follow the pattern from tests for shots models. Test:

    1. CharacterPosition:
       - to_dict() produces correct dict with sorted lists
       - from_dict() recreates object correctly
       - Default values work

    2. PropPosition:
       - to_dict() produces correct dict
       - from_dict() recreates object

    3. CameraSetup:
       - to_dict() includes all nested dicts (camera, target)
       - from_dict() handles nested dicts correctly
       - lens_mm and sensor_width defaults

    4. SceneLayout:
       - to_dict() includes all nested lists
       - from_dict() recreates nested objects
       - Empty lists handled correctly

    5. LayoutBrief:
       - to_dict() includes version, project_id, generated_at
       - save() writes valid JSON file
       - from_dict() and load() work correctly

    6. Determinism:
       - Multiple to_dict() calls produce identical output
       - Sorted lists are actually sorted

    Structure:
    ```python
    import pytest
    from datetime import datetime
    from pathlib import Path
    import json

    from core.layout.models import (
        CharacterPosition,
        PropPosition,
        CameraSetup,
        SceneLayout,
        LayoutBrief,
    )


    class TestCharacterPosition:
        def test_to_dict(self):
            ...

        def test_from_dict(self):
            ...

        def test_roundtrip(self):
            ...


    class TestCameraSetup:
        ...


    class TestSceneLayout:
        ...


    class TestLayoutBrief:
        ...


    class TestDeterminism:
        def test_sorted_lists(self):
            ...

        def test_reproducible_output(self):
            ...
    ```
  </action>
  <verify>
    python -m pytest tests/unit/test_layout_models.py -v
  </verify>
  <done>
    - tests/unit/test_layout_models.py exists
    - All dataclasses have test coverage
    - to_dict/from_dict roundtrip tests pass
    - Determinism tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for camera math</name>
  <files>tests/unit/test_layout_camera_math.py</files>
  <action>
    Create comprehensive tests for camera position calculation.

    Test:

    1. calculate_camera_position():
       - Test all shot types (WS, MS, MCU, CU, ECU, INSERT, OTS, POV, TWO)
       - Verify distances match cinematography standards
       - Verify camera height varies by shot type
       - Verify CameraPosition and CameraRotation types returned

    2. Distance mapping:
       - WS: 5.0m from subject
       - MS: 2.5m from subject
       - MCU: 1.8m from subject
       - CU: 1.2m from subject
       - ECU: 0.8m from subject
       - INSERT: 0.5m from subject
       - OTS: 2.0m from subject
       - POV: 1.7m from subject
       - TWO: 3.0m from subject

    3. Camera positioning:
       - Camera placed in front of subject (negative Y)
       - Camera at eye level (1.6m) for most shots
       - Camera raised (2.0m) for WS

    4. Edge cases:
       - Unknown shot type uses default distance
       - Subject at origin
       - Subject at non-origin position

    Structure:
    ```python
    import pytest
    from core.layout.camera_math import (
        calculate_camera_position,
        CameraPosition,
        CameraRotation,
    )


    class TestCalculateCameraPosition:
        def test_wide_shot_distance(self):
            pos, rot = calculate_camera_position("WS", (0, 0, 0))
            assert abs(pos.y - (-5.0)) < 0.1  # 5m in front

        def test_medium_shot_distance(self):
            pos, rot = calculate_camera_position("MS", (0, 0, 0))
            assert abs(pos.y - (-2.5)) < 0.1

        def test_close_up_distance(self):
            pos, rot = calculate_camera_position("CU", (0, 0, 0))
            assert abs(pos.y - (-1.2)) < 0.1

        def test_returns_correct_types(self):
            pos, rot = calculate_camera_position("MS", (0, 0, 0))
            assert isinstance(pos, CameraPosition)
            assert isinstance(rot, CameraRotation)

        def test_unknown_shot_type_uses_default(self):
            pos, rot = calculate_camera_position("UNKNOWN", (0, 0, 0))
            assert pos.y < 0  # Should still be in front

        def test_subject_offset(self):
            pos, rot = calculate_camera_position("MS", (5, 5, 0))
            # Camera should maintain relative positioning
            assert abs(pos.x - 5) < 0.1
    ```
  </action>
  <verify>
    python -m pytest tests/unit/test_layout_camera_math.py -v
  </verify>
  <done>
    - tests/unit/test_layout_camera_math.py exists
    - All shot types tested with correct distances
    - Camera positioning logic verified
    - Edge cases handled
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for LayoutBriefGenerator</name>
  <files>tests/unit/test_layout_generator.py</files>
  <action>
    Create tests for LayoutBriefGenerator using fixtures.

    Test:

    1. Generator initialization:
       - Creates with build_path
       - Loads ScriptGraph and ShotGraph

    2. Scene layout generation:
       - Creates SceneLayout for each scene
       - Maps characters to CharacterPosition objects
       - Maps shots to CameraSetup objects

    3. Camera setup creation:
       - Uses calculate_camera_position() correctly
       - Links shot_id to CameraSetup

    4. Evidence propagation:
       - Scene evidence_ids present in SceneLayout
       - Shot evidence_ids present in CameraSetup

    5. Empty/missing data handling:
       - Empty scenes produce empty layouts
       - Missing characters handled gracefully
       - Missing shots handled gracefully

    Use fixture data with minimal ScriptGraph and ShotGraph.

    Structure:
    ```python
    import pytest
    import json
    from pathlib import Path
    import tempfile

    from core.layout.generator import LayoutBriefGenerator, LayoutGenerationResult
    from core.layout.models import LayoutBrief


    @pytest.fixture
    def sample_scriptgraph():
        return {
            "version": "1.0",
            "project_id": "test-project",
            "scenes": [
                {
                    "id": "SCN_001",
                    "order": 1,
                    "slugline": "INT. COFFEE SHOP - DAY",
                    "int_ext": "INT",
                    "time_of_day": "DAY",
                    "links": {
                        "characters": ["CHAR_john", "CHAR_jane"],
                        "locations": ["LOC_coffee_shop"],
                        "evidence_ids": ["EV_001"]
                    }
                }
            ]
        }


    @pytest.fixture
    def sample_shotgraph():
        return {
            "version": "1.0",
            "project_id": "test-project",
            "shots": [
                {
                    "shot_id": "shot_001_001",
                    "scene_id": "SCN_001",
                    "scene_number": 1,
                    "shot_number": 1,
                    "shot_type": "WS",
                    "movement": "Static",
                    "description": "Establishing shot",
                    "evidence_ids": ["EV_002"]
                }
            ]
        }


    class TestLayoutBriefGenerator:
        def test_generate_creates_layout_brief(self, sample_scriptgraph, sample_shotgraph):
            with tempfile.TemporaryDirectory() as tmpdir:
                build_path = Path(tmpdir)
                (build_path / "scriptgraph.json").write_text(json.dumps(sample_scriptgraph))
                (build_path / "shotgraph.json").write_text(json.dumps(sample_shotgraph))

                generator = LayoutBriefGenerator(build_path)
                brief = generator.generate()

                assert isinstance(brief, LayoutBrief)
                assert brief.project_id == "test-project"

        def test_scene_layout_includes_characters(self, sample_scriptgraph, sample_shotgraph):
            ...

        def test_scene_layout_includes_cameras(self, sample_scriptgraph, sample_shotgraph):
            ...

        def test_evidence_ids_propagated(self, sample_scriptgraph, sample_shotgraph):
            ...
    ```
  </action>
  <verify>
    python -m pytest tests/unit/test_layout_generator.py -v
  </verify>
  <done>
    - tests/unit/test_layout_generator.py exists
    - Generator produces valid LayoutBrief
    - Characters and cameras included in layouts
    - Evidence IDs propagated correctly
    - Fixtures provide test data
  </done>
</task>

<task type="auto">
  <name>Task 4: Create integration tests for layout workflow</name>
  <files>tests/integration/test_layout_workflow.py</files>
  <action>
    Create end-to-end integration tests following the test_shot_workflow.py pattern.

    Test the full pipeline:
    1. Given a project with ScriptGraph and ShotGraph
    2. Run 'gsd generate-layout'
    3. Verify blender/ directory created
    4. Verify layout_brief.json files exist
    5. Verify JSON content is valid

    Structure:
    ```python
    import pytest
    import json
    import subprocess
    from pathlib import Path
    import tempfile
    import shutil

    from apps.cli.cli import main


    class TestLayoutWorkflow:
        @pytest.fixture
        def project_with_data(self, tmp_path):
            \"\"\"Create a test project with ScriptGraph and ShotGraph.\"\"\"
            # Create project structure
            build_path = tmp_path / "build"
            build_path.mkdir()

            # Create ScriptGraph
            scriptgraph = {
                "version": "1.0",
                "project_id": "test-project",
                "scenes": [
                    {
                        "id": "SCN_001",
                        "order": 1,
                        "slugline": "INT. OFFICE - DAY",
                        "int_ext": "INT",
                        "time_of_day": "DAY",
                        "links": {
                            "characters": ["CHAR_alice"],
                            "locations": ["LOC_office"],
                            "evidence_ids": ["EV_001"]
                        }
                    }
                ]
            }
            (build_path / "scriptgraph.json").write_text(json.dumps(scriptgraph))

            # Create ShotGraph
            shotgraph = {
                "version": "1.0",
                "project_id": "test-project",
                "shots": [
                    {
                        "shot_id": "shot_001_001",
                        "scene_id": "SCN_001",
                        "scene_number": 1,
                        "shot_number": 1,
                        "shot_type": "WS",
                        "movement": "Static",
                        "description": "Establishing shot",
                        "evidence_ids": []
                    },
                    {
                        "shot_id": "shot_001_002",
                        "scene_id": "SCN_001",
                        "scene_number": 1,
                        "shot_number": 2,
                        "shot_type": "CU",
                        "movement": "Static",
                        "description": "Close-up",
                        "evidence_ids": []
                    }
                ]
            }
            (build_path / "shotgraph.json").write_text(json.dumps(shotgraph))

            return tmp_path

        def test_generate_layout_creates_files(self, project_with_data):
            \"\"\"Test that generate-layout creates output files.\"\"\"
            from core.layout import LayoutBriefGenerator, LayoutBriefExporter

            build_path = project_with_data / "build"
            generator = LayoutBriefGenerator(build_path)
            brief = generator.generate()

            exporter = LayoutBriefExporter(project_with_data)
            paths = exporter.export(brief)

            assert len(paths) == 1
            assert "SCN_001" in paths
            assert paths["SCN_001"].exists()

        def test_layout_brief_json_valid(self, project_with_data):
            \"\"\"Test that output JSON is valid.\"\"\"
            from core.layout import LayoutBriefGenerator, LayoutBriefExporter

            build_path = project_with_data / "build"
            generator = LayoutBriefGenerator(build_path)
            brief = generator.generate()

            exporter = LayoutBriefExporter(project_with_data)
            paths = exporter.export(brief)

            # Verify JSON is valid
            for scene_id, path in paths.items():
                data = json.loads(path.read_text())
                assert "scene_id" in data
                assert "camera_setups" in data

        def test_camera_setups_present(self, project_with_data):
            \"\"\"Test that camera setups are generated.\"\"\"
            from core.layout import LayoutBriefGenerator, LayoutBriefExporter

            build_path = project_with_data / "build"
            generator = LayoutBriefGenerator(build_path)
            brief = generator.generate()

            scene = brief.scene_layouts[0]
            assert len(scene.camera_setups) == 2  # 2 shots in fixture

        def test_camera_positions_valid(self, project_with_data):
            \"\"\"Test that camera positions have valid coordinates.\"\"\"
            from core.layout import LayoutBriefGenerator

            build_path = project_with_data / "build"
            generator = LayoutBriefGenerator(build_path)
            brief = generator.generate()

            for scene in brief.scene_layouts:
                for cam in scene.camera_setups:
                    pos = cam.camera["position"]
                    assert "x" in pos
                    assert "y" in pos
                    assert "z" in pos
                    assert isinstance(pos["x"], (int, float))
    ```
  </action>
  <verify>
    python -m pytest tests/integration/test_layout_workflow.py -v
  </verify>
  <done>
    - tests/integration/test_layout_workflow.py exists
    - End-to-end test passes with fixture data
    - Output files created in correct structure
    - JSON content validated
  </done>
</task>

</tasks>

<verification>
1. All unit tests pass: pytest tests/unit/test_layout_*.py -v
2. Integration tests pass: pytest tests/integration/test_layout_workflow.py -v
3. Test count matches expected (~20-30 tests)
</verification>

<success_criteria>
- Unit tests for layout models (test_layout_models.py)
- Unit tests for camera math (test_layout_camera_math.py)
- Unit tests for generator (test_layout_generator.py)
- Integration tests for workflow (test_layout_workflow.py)
- All tests passing
- Coverage includes happy path, edge cases, and determinism
</success_criteria>

<output>
After completion, create `.planning/phases/06-blender-integration/06-04-SUMMARY.md`
</output>
