---
phase: 01-canon-extraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - core/canon/__init__.py
  - core/canon/vault_writer.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Running gsd build canon creates files in vault/10_Characters/"
    - "Running gsd build canon creates files in vault/20_Locations/"
    - "Running gsd build canon creates files in vault/50_Scenes/"
    - "Each vault note links back to inbox source material"
    - "StoryGraph JSON contains all extracted entities"
  artifacts:
    - path: "core/canon/__init__.py"
      provides: "CanonBuilder with vault writing integration"
      exports: ["CanonBuilder", "build_canon", "CanonBuildResult"]
    - path: "build/storygraph.json"
      provides: "Canonical entity graph"
      contains: "entities array"
    - path: "vault/10_Characters/"
      provides: "Character notes"
  key_links:
    - from: "core/canon/__init__.py"
      to: "core/vault/note_writer.py"
      via: "import VaultNoteWriter"
      pattern: "from.*vault.*import"
    - from: "core/canon/__init__.py"
      to: "build/storygraph.json"
      via: "json write"
      pattern: "write_text.*json"
    - from: "core/canon/__init__.py"
      to: "vault/*/"
      via: "note writer"
      pattern: "write_character|write_location|write_scene"
---

<objective>
Integrate VaultNoteWriter into CanonBuilder so that building canon produces vault notes with evidence links.

Purpose: Complete the canon extraction pipeline by writing extracted entities to the Obsidian vault, linking each entity back to its source evidence.

Output: Updated CanonBuilder that writes vault notes during build(), with all 71 existing tests still passing.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing code to modify
@core/canon/__init__.py
@core/vault/note_writer.py (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vault writing to CanonBuilder</name>
  <files>core/canon/__init__.py</files>
  <action>
Modify `core/canon/__init__.py` to integrate VaultNoteWriter.

Changes needed:

1. Import VaultNoteWriter at top of file:
   ```python
   from ..vault import VaultNoteWriter
   ```

2. In CanonBuilder.__init__, create vault writer:
   ```python
   self.vault_writer = VaultNoteWriter(self.vault_path, self.build_path)
   ```

3. In build() method, after _update_storygraph(), add vault writing:
   ```python
   # Write vault notes
   self._write_vault_notes()
   ```

4. Add new method `_write_vault_notes(self)`:
   - Load evidence_index.json to map block refs to source files
   - Iterate through self._entities and call appropriate vault_writer method:
     - type == "character" -> vault_writer.write_character()
     - type == "location" -> vault_writer.write_location()
     - type == "scene" -> vault_writer.write_scene()
   - Pass evidence_index so writer can build full wikilinks

5. Update CanonBuildResult to track vault notes written:
   - Add `vault_notes_written: int = 0` to dataclass
   - Increment in _write_vault_notes()
  </action>
  <verify>
python -c "from core.canon import CanonBuilder; cb = CanonBuilder(Path('.'), {}); print('Vault writer integrated')"
  </verify>
  <done>CanonBuilder has vault_writer attribute and calls _write_vault_notes() during build()</done>
</task>

<task type="auto">
  <name>Task 2: Update VaultNoteWriter to accept evidence index</name>
  <files>core/vault/note_writer.py</files>
  <action>
Modify VaultNoteWriter to properly handle evidence link resolution.

Changes needed:

1. Update __init__ signature:
   ```python
   def __init__(self, vault_path: Path, build_path: Path = None):
       self.vault_path = vault_path
       self.build_path = build_path or vault_path.parent / "build"
       self._evidence_index = None
   ```

2. Add method to load evidence index:
   ```python
   def _load_evidence_index(self) -> dict:
       if self._evidence_index is None:
           path = self.build_path / "evidence_index.json"
           if path.exists():
               self._evidence_index = json.loads(path.read_text())
           else:
               self._evidence_index = {"evidence": {}}
       return self._evidence_index
   ```

3. Update format_evidence_links to resolve block refs:
   ```python
   def format_evidence_links(self, evidence_ids: list) -> str:
       index = self._load_evidence_index()
       links = []
       for ev_id in evidence_ids:
           ev_data = index.get("evidence", {}).get(ev_id, {})
           source = ev_data.get("source_path", "unknown")
           link = f"[[{source}#^{ev_id}]]"
           links.append(link)
       return "\n".join(f"- {link}" for link in links)
   ```

4. Ensure write_character, write_location, write_scene all:
   - Pass entity's evidence_ids to format_evidence_links
   - Include formatted links in template output
  </action>
  <verify>
python -c "from core.vault import VaultNoteWriter; print('Evidence index support OK')"
  </verify>
  <done>VaultNoteWriter loads evidence_index.json and resolves block refs to full wikilinks</done>
</task>

<task type="auto">
  <name>Task 3: Ensure all existing tests pass</name>
  <files>tests/integration/test_canon_pipeline.py</files>
  <action>
Run all existing tests and verify none are broken by the changes.

If tests fail:
1. Check that CanonBuilder signature is backward compatible
2. Check that build() returns CanonBuildResult with expected fields
3. Check that vault_writer doesn't crash when evidence_index is missing

Key tests to verify:
- test_full_pipeline_with_simple_content - Should now create vault notes
- test_storygraph_persistence - Should still work
- test_entity_linking_across_files - Should still link entities
- test_disambiguation_queue_persistence - Should still queue items

Run: python -m pytest tests/ -v --tb=short
  </action>
  <verify>
python -m pytest tests/ -v --tb=short 2>&1 | tail -5
  </verify>
  <done>All 71 existing tests pass, new functionality doesn't break existing behavior</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `python -m pytest tests/ -v` passes with 71+ tests
2. `gsd build canon` in a test project creates files in vault/
3. Vault notes contain evidence links to inbox source
</verification>

<success_criteria>
- [ ] CanonBuilder imports and uses VaultNoteWriter
- [ ] CanonBuilder._write_vault_notes() method exists and is called
- [ ] VaultNoteWriter.format_evidence_links() resolves to full wikilinks
- [ ] All 71 existing tests pass
- [ ] CanonBuildResult includes vault_notes_written field
</success_criteria>

<output>
After completion, create `.planning/phases/01-canon-extraction/01-02-SUMMARY.md`
</output>
