---
phase: 01-canon-extraction
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-02
files_modified:
  - core/canon/__init__.py
  - apps/cli/cli.py
  - tests/integration/test_canon_pipeline.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can run gsd build canon and see results in terminal"
    - "User can run gsd status and see entity counts"
    - "Running gsd build canon twice produces same output"
    - "Evidence links in vault notes are clickable in Obsidian"
  artifacts:
    - path: "apps/cli/cli.py"
      provides: "CLI commands for build, status"
      exports: ["cmd_build", "cmd_status"]
    - path: "core/canon/__init__.py"
      provides: "Deterministic canon building"
      exports: ["build_canon"]
    - path: "build/storygraph.json"
      provides: "Canonical entity storage"
  key_links:
    - from: "apps/cli/cli.py"
      to: "core/canon"
      via: "from core.canon import build_canon"
      pattern: "from.*canon.*import"
    - from: "core/canon/__init__.py"
      to: "build/storygraph.json"
      via: "json dump"
      pattern: "json.dumps"
---

<objective>
Polish the CLI integration and ensure deterministic builds so that running the canon build pipeline produces consistent, verifiable results.

Purpose: Complete the user-facing experience of Phase 1 by ensuring CLI commands work correctly and builds are deterministic for diff-based change detection.

Output: Fully integrated CLI with deterministic canon builds, validated by integration tests.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing code to modify
@apps/cli/cli.py
@core/canon/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update cmd_build to show vault output</name>
  <files>apps/cli/cli.py</files>
  <action>
Update cmd_build() in cli.py to report vault note creation.

Current output shows:
```
Characters: X created, Y linked
Locations: X created, Y linked
Scenes: X created
Disambiguation items: X queued
```

Add vault output:
```
Characters: X created, Y linked
Locations: X created, Y linked
Scenes: X created
Vault notes: X written
Disambiguation items: X queued
```

Also update the "Next:" message:
- If vault_notes_written > 0: "Vault notes created in: vault/10_Characters/, vault/20_Locations/, vault/50_Scenes/"
- If queue_items > 0: "Next: gsd resolve  # Review X disambiguation items"
  </action>
  <verify>
cd /Users/bretbouchard/apps/fdx_gsd && python -c "from apps.cli.cli import cmd_build; print('cmd_build OK')"
  </verify>
  <done>cmd_build shows vault_notes_written in output and updated next steps</done>
</task>

<task type="auto">
  <name>Task 2: Ensure deterministic build output</name>
  <files>core/canon/__init__.py</files>
  <action>
Ensure that running build_canon() twice with same input produces identical output.

Changes needed:

1. Sort entities when writing to storygraph.json:
   ```python
   # In _update_storygraph
   storygraph["entities"] = sorted(
       storygraph["entities"],
       key=lambda e: (e.get("type", ""), e.get("id", ""))
   )
   ```

2. Sort queue items when writing disambiguation_queue.json:
   ```python
   # In _update_disambiguation_queue
   existing["items"] = sorted(
       existing["items"],
       key=lambda i: i.get("id", "")
   )
   ```

3. Sort evidence_ids in each entity:
   ```python
   # When creating entity
   entity["evidence_ids"] = sorted(set(entity.get("evidence_ids", [])))
   ```

4. Use consistent timestamp format (ISO 8601):
   - Already using datetime.now().isoformat() - verify this is consistent

5. Add test for determinism:
   - Create integration test that runs build_canon twice
   - Assert storygraph.json content is identical
   - Assert disambiguation_queue.json content is identical
  </action>
  <verify>
python -m pytest tests/integration/test_canon_pipeline.py -k determinism -v --tb=short 2>&1 || echo "Test may not exist yet"
  </verify>
  <done>Build output is deterministic - same input produces byte-identical JSON files</done>
</task>

<task type="auto">
  <name>Task 3: Add end-to-end integration test</name>
  <files>tests/integration/test_canon_pipeline.py</files>
  <action>
Add comprehensive end-to-end test to test_canon_pipeline.py:

```python
def test_full_e2e_canon_build(self, temp_project):
    \"\"\"End-to-end test of complete canon build with vault output.\"\"\"
    # 1. Create inbox file with screenplay content
    # 2. Run build_canon()
    # 3. Verify storygraph.json has entities
    # 4. Verify vault/10_Characters/ has character notes
    # 5. Verify vault/20_Locations/ has location notes
    # 6. Verify vault/50_Scenes/ has scene notes
    # 7. Verify vault notes have evidence links
    # 8. Verify evidence links resolve to inbox files
    pass

def test_deterministic_build_output(self, temp_project):
    \"\"\"Test that running build twice produces identical output.\"\"\"
    # Create inbox file
    # Run build_canon() -> capture storygraph.json
    # Run build_canon() again -> capture storygraph.json
    # Assert both are identical
    pass
```

Test should cover:
- Characters: JOHN, MARY (proper nouns + ALL CAPS)
- Locations: COFFEE SHOP, PARK (sluglines)
- Scenes: 3+ sluglines
- Evidence: Links from each entity to source
  </action>
  <verify>
python -m pytest tests/integration/test_canon_pipeline.py::TestCanonBuilderIntegration::test_full_e2e_canon_build -v --tb=short
  </verify>
  <done>End-to-end integration test passes, validating complete pipeline</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `python -m pytest tests/integration/test_canon_pipeline.py -v` passes with new tests
2. Running `gsd build canon` shows vault notes written
3. Running build twice produces identical storygraph.json
</verification>

<success_criteria>
- [ ] cmd_build reports vault_notes_written
- [ ] Entities in storygraph.json are sorted deterministically
- [ ] Queue items are sorted deterministically
- [ ] test_full_e2e_canon_build passes
- [ ] test_deterministic_build_output passes
- [ ] All existing tests still pass (71+)
</success_criteria>

<output>
After completion, create `.planning/phases/01-canon-extraction/01-03-SUMMARY.md`
</output>
