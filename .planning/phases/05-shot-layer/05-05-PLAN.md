---
phase: 05-shot-layer
plan: 05
type: execute
wave: 5
depends_on: ["05-04"]
files_modified:
  - tests/unit/shots/test_types.py
  - tests/unit/shots/test_models.py
  - tests/unit/shots/test_detector.py
  - tests/unit/shots/test_exporter.py
  - tests/unit/shots/test_suggester.py
  - tests/integration/test_shot_workflow.py
autonomous: true

must_haves:
  truths:
    - "All shot module unit tests pass"
    - "Integration test validates end-to-end shot workflow"
    - "Test coverage includes all detection rules"
  artifacts:
    - path: "tests/unit/shots/test_types.py"
      provides: "Unit tests for shot type enums"
    - path: "tests/unit/shots/test_models.py"
      provides: "Unit tests for Shot and ShotList dataclasses"
    - path: "tests/unit/shots/test_detector.py"
      provides: "Unit tests for ShotDetector heuristics"
    - path: "tests/unit/shots/test_exporter.py"
      provides: "Unit tests for ShotListExporter"
    - path: "tests/unit/shots/test_suggester.py"
      provides: "Unit tests for ShotSuggester"
    - path: "tests/integration/test_shot_workflow.py"
      provides: "End-to-end test for shot suggestion workflow"
  key_links:
    - from: "tests/unit/shots/test_detector.py"
      to: "core/shots/detector.py"
      via: "Tests all detection methods"
    - from: "tests/integration/test_shot_workflow.py"
      to: "core/shots/suggester.py"
      via: "Tests suggest() -> export workflow"
---

<objective>
Create comprehensive unit and integration tests for the Shot Layer.

Purpose: Validate shot detection rules, export functionality, and end-to-end workflow.
Output: Test files in tests/unit/shots/ and tests/integration/
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern references from existing tests
@tests/unit/validation/test_base.py
@tests/integration/test_script_workflow.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for shot types and models</name>
  <files>tests/unit/shots/test_types.py, tests/unit/shots/test_models.py</files>
  <action>
Create unit tests following the pattern from tests/unit/validation/test_base.py.

test_types.py:
- test_shot_type_values(): Verify all ShotType enum values are correct strings
- test_camera_angle_values(): Verify all CameraAngle enum values
- test_camera_movement_values(): Verify all CameraMovement enum values
- test_shot_type_lookup(): Verify ShotType("CU") returns correct enum

test_models.py:
- test_shot_creation(): Create Shot with required fields, verify attributes
- test_shot_to_dict(): Verify serialization produces correct dict with sorted lists
- test_shot_from_dict(): Verify deserialization reconstructs Shot correctly
- test_shot_list_creation(): Create ShotList with multiple shots
- test_shot_list_to_dict(): Verify ShotList serialization with sorted shots
- test_shot_list_get_shots_for_scene(): Filter shots by scene_id
- test_shot_list_save(): Save to JSON file and verify contents
- test_deterministic_output(): Same Shot should produce same to_dict() output

Create tests/unit/shots/__init__.py if needed.
</action>
  <verify>cd /Users/bretbouchard/apps/fdx_gsd && python -m pytest tests/unit/shots/test_types.py tests/unit/shots/test_models.py -v --tb=short</verify>
  <done>All type and model tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for ShotDetector</name>
  <files>tests/unit/shots/test_detector.py</files>
  <action>
Create comprehensive tests for shot detection heuristics.

test_detector.py:
- test_detector_initialization(): ShotDetector creates with keyword sets
- test_detect_emotional_dialogue_cry(): Dialogue with "cry" returns CU shot
- test_detect_emotional_dialogue_whisper(): Dialogue with "whisper" returns CU shot
- test_detect_emotional_dialogue_smile(): Dialogue with "smile" returns CU shot
- test_detect_movement_walks(): Action with "walks" returns MS shot
- test_detect_movement_enters(): Action with "enters" returns MS shot
- test_detect_movement_runs(): Action with "runs" returns MS shot
- test_detect_detail_insert_ring(): Action with "ring" returns INSERT shot
- test_detect_detail_insert_letter(): Action with "letter" returns INSERT shot
- test_detect_pov_sees(): Text with "sees" returns POV shot
- test_detect_no_match(): Regular text returns None
- test_evidence_propagation(): Detected shot includes evidence_ids from paragraph
- test_character_extraction(): Dialogue paragraph extracts character name
- test_mixed_content(): Action with both movement and detail prefers first match

Use fixture paragraphs with realistic screenplay content.
</action>
  <verify>cd /Users/bretbouchard/apps/fdx_gsd && python -m pytest tests/unit/shots/test_detector.py -v --tb=short</verify>
  <done>All detector tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for ShotListExporter</name>
  <files>tests/unit/shots/test_exporter.py</files>
  <action>
Create tests for CSV and JSON export functionality.

test_exporter.py:
- test_exporter_initialization(): ShotListExporter creates successfully
- test_export_csv_creates_file(): export_csv creates file at output path
- test_export_csv_headers(): CSV has correct column headers
- test_export_csv_row_formatting(): CSV rows have correct values and formatting
- test_export_csv_empty_shot_list(): Handles empty shot list gracefully
- test_export_json_creates_file(): export_json creates valid JSON file
- test_export_json_content(): JSON file contains correct ShotList data
- test_get_summary(): get_summary returns correct statistics
- test_get_summary_by_type(): Summary includes breakdown by shot type
- test_get_summary_by_scene(): Summary includes breakdown by scene

Use tempfile for output paths to avoid polluting project.
</action>
  <verify>cd /Users/bretbouchard/apps/fdx_gsd && python -m pytest tests/unit/shots/test_exporter.py -v --tb=short</verify>
  <done>All exporter tests pass</done>
</task>

<task type="auto">
  <name>Task 4: Create unit tests for ShotSuggester</name>
  <files>tests/unit/shots/test_suggester.py</files>
  <action>
Create tests for the ShotSuggester orchestrator.

test_suggester.py:
- test_suggester_initialization(): ShotSuggester creates with build_path
- test_suggester_loads_scriptgraph(): _load_scriptgraph loads valid JSON
- test_suggester_no_scriptgraph(): Returns error when no scriptgraph.json
- test_suggester_empty_scenes(): Handles empty scenes list
- test_create_shot_id(): Shot IDs follow correct format (shot_XXX_YYY)
- test_add_shot(): _add_shot creates and appends Shot correctly
- test_establishing_shot_always_first(): Every scene starts with WS
- test_suggest_processes_all_scenes(): suggest() processes all scenes in scriptgraph
- test_suggest_returns_result(): suggest() returns ShotSuggestionResult
- test_get_shots_sorted(): get_shots returns shots sorted by scene/shot number
- test_get_shot_list(): get_shot_list returns valid ShotList
- test_get_summary(): get_summary returns correct statistics
- test_scene_with_dialogue_generates_shots(): Dialogue scene generates CU shots
- test_scene_with_movement_generates_shots(): Action scene generates MS shots
- test_two_character_scene_generates_ots(): Scene with 2 characters gets OTS suggestion

Use fixtures for test scriptgraph data.
</action>
  <verify>cd /Users/bretbouchard/apps/fdx_gsd && python -m pytest tests/unit/shots/test_suggester.py -v --tb=short</verify>
  <done>All suggester tests pass</done>
</task>

<task type="auto">
  <name>Task 5: Create integration test for shot workflow</name>
  <files>tests/integration/test_shot_workflow.py</files>
  <action>
Create end-to-end integration test following the pattern from tests/integration/test_script_workflow.py.

test_shot_workflow.py:
- test_full_shot_workflow():
  1. Create test project with scriptgraph.json
  2. Run ShotSuggester.suggest()
  3. Verify ShotSuggestionResult is successful
  4. Get ShotList and verify shots exist
  5. Export to CSV
  6. Verify CSV file exists and has correct content
  7. Export to JSON (shotgraph.json)
  8. Verify JSON file exists and is valid

- test_shot_workflow_with_emotional_scene():
  1. Create scriptgraph with emotional dialogue scene
  2. Run suggester
  3. Verify CU shots generated for emotional content

- test_shot_workflow_with_action_scene():
  1. Create scriptgraph with action scene
  2. Run suggester
  3. Verify MS shots generated for movement

- test_deterministic_rebuild():
  1. Run suggester twice on same scriptgraph
  2. Verify shot IDs and order are identical

Use tempfile for test project directory.
</action>
  <verify>cd /Users/bretbouchard/apps/fdx_gsd && python -m pytest tests/integration/test_shot_workflow.py -v --tb=short</verify>
  <done>All integration tests pass</done>
</task>

</tasks>

<verification>
- All unit tests in tests/unit/shots/ pass
- Integration test validates end-to-end workflow
- Test coverage includes all detection rules
- Deterministic output verified
</verification>

<success_criteria>
- pytest tests/unit/shots/ passes (all unit tests)
- pytest tests/integration/test_shot_workflow.py passes
- Total test count increases by ~25-35 tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-shot-layer/05-05-SUMMARY.md`
</output>
