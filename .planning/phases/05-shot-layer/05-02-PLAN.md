---
phase: 05-shot-layer
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - core/shots/detector.py
  - core/shots/exporter.py
autonomous: true

must_haves:
  truths:
    - "ShotDetector detects emotional dialogue shots"
    - "ShotDetector detects movement shots"
    - "ShotDetector detects detail insert shots"
    - "ShotListExporter produces StudioBinder-compatible CSV"
    - "ShotListExporter produces JSON export"
  artifacts:
    - path: "core/shots/detector.py"
      provides: "ShotDetector with heuristic rules"
      exports: ["ShotDetector"]
    - path: "core/shots/exporter.py"
      provides: "ShotListExporter for CSV/JSON"
      exports: ["ShotListExporter"]
  key_links:
    - from: "core/shots/detector.py"
      to: "core/shots/models.py"
      via: "import Shot, ShotType"
      pattern: "from .models import"
    - from: "core/shots/exporter.py"
      to: "core/shots/models.py"
      via: "import Shot, ShotList"
      pattern: "from .models import"
---

<objective>
Create the shot detection heuristics and export functionality.

Purpose: Rule-based shot detection from paragraph content and CSV/JSON export for production tools.
Output: detector.py and exporter.py modules
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern references
@core/script/beats.py
@core/shots/types.py
@core/shots/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core/shots/detector.py with ShotDetector</name>
  <files>core/shots/detector.py</files>
  <action>
Create ShotDetector class with rule-based heuristics for shot detection, following the BeatExtractor pattern from core/script/beats.py.

Key detection rules:

1. EMOTIONAL_KEYWORDS (set): cry, tears, sob, scream, whisper, gasp, shock, horror, love, hate, fear, anger, smile, laugh, grin, frown, tremble, shake, pale, flush, blush

2. MOVEMENT_VERBS (set): walks, runs, enters, exits, moves, crosses, approaches, retreats, chases, flees, rushes, sprints, strolls, wanders, storms, strides

3. DETAIL_INDICATORS (set): ring, letter, phone, gun, knife, key, photograph, watch, blood, tear, locket, coin, map, book, note, card, flower, medal, tattoo

4. POV_INDICATORS (set): sees, watches, looks at, notices, spots, glimpses, stares, gazes, observes

ShotDetector class methods:
- __init__(self): Initialize keyword sets
- detect_from_paragraph(paragraph: Dict, scene: Dict) -> Optional[Shot]: Analyze a paragraph and return a Shot if opportunity detected
- _detect_emotional_dialogue(paragraph: Dict, scene: Dict) -> Optional[Shot]: Check for emotional keywords in dialogue -> CU
- _detect_movement_action(paragraph: Dict, scene: Dict) -> Optional[Shot]: Check for movement verbs in action -> MS or WS
- _detect_detail_insert(paragraph: Dict, scene: Dict) -> Optional[Shot]: Check for detail indicators -> INSERT
- _detect_pov_opportunity(paragraph: Dict, scene: Dict) -> Optional[Shot]: Check for POV phrases -> POV
- _extract_character(paragraph: Dict) -> str: Extract character name from dialogue paragraph
- _extract_detail(text: str) -> str: Extract the detail object from text

Detection logic:
- Dialogue with emotional keywords -> Close-up (CU)
- Action with movement verbs -> Medium Shot (MS)
- Action with detail indicators -> Insert (INSERT)
- Text with POV indicators -> POV (lower priority)

Each detected shot must include:
- shot_type from the appropriate enum
- description explaining why the shot was suggested
- evidence_ids from the source paragraph
- subject if a character is involved
</action>
  <verify>python -c "from core.shots.detector import ShotDetector; d = ShotDetector(); print('Detector initialized:', d is not None)"</verify>
  <done>ShotDetector can analyze paragraphs and return appropriate Shot objects</done>
</task>

<task type="auto">
  <name>Task 2: Create core/shots/exporter.py with ShotListExporter</name>
  <files>core/shots/exporter.py</files>
  <action>
Create ShotListExporter class for CSV and JSON export, following StudioBinder column standards.

CORE_COLUMNS (list):
- scene_number, shot_number, description, shot_size, camera_angle, movement, subject, location, cast, notes

ShotListExporter methods:
- __init__(self): No special init needed
- export_csv(shot_list: ShotList, output_path: Path) -> None: Export to CSV with DictWriter
  - Create parent directories if needed
  - Write header row
  - Write one row per shot with mapped columns
  - shot_size -> shot.shot_type.value
  - camera_angle -> shot.angle.value
  - movement -> shot.movement.value
  - cast -> ", ".join(shot.characters)
- export_json(shot_list: ShotList, output_path: Path) -> None: Export to JSON using shot_list.save()
- get_summary(shot_list: ShotList) -> Dict[str, Any]: Return stats about shot list
  - total_shots: count
  - by_type: dict of ShotType -> count
  - by_scene: dict of scene_number -> count

CSV formatting requirements:
- Use csv.DictWriter with CORE_COLUMNS as fieldnames
- newline='' for proper line endings
- encoding='utf-8'
- Handle empty values gracefully (empty string, not None)
</action>
  <verify>python -c "from core.shots.exporter import ShotListExporter; e = ShotListExporter(); print('Exporter initialized:', e is not None)"</verify>
  <done>ShotListExporter produces valid CSV and JSON files</done>
</task>

</tasks>

<verification>
- ShotDetector has all keyword sets defined
- ShotDetector.detect_from_paragraph returns Shot for matching content
- ShotListExporter.export_csv produces StudioBinder-compatible CSV
- ShotListExporter.export_json produces valid JSON
</verification>

<success_criteria>
- Emotional dialogue text returns Shot with shot_type=ShotType.CU
- Movement action text returns Shot with shot_type=ShotType.MS
- Detail insert text returns Shot with shot_type=ShotType.INSERT
- CSV export has correct column headers and properly formatted rows
</success_criteria>

<output>
After completion, create `.planning/phases/05-shot-layer/05-02-SUMMARY.md`
</output>
